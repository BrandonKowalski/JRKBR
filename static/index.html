<!DOCTYPE html>
<html>
<head>
    <title>Jerry</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            font-family: Arial, sans-serif;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
        }

        #cat-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #cat-face {
            width: 70vmin;
            height: 70vmin;
            background-color: #fff;
            border-radius: 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .eyes {
            display: flex;
            justify-content: space-between;
            width: 50%;
        }

        .eye {
            width: 10vmin;
            height: 16vmin;
            background-color: #000;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .pupil {
            width: 5vmin;
            height: 5vmin;
            background-color: #fff;
            border-radius: 50%;
            position: relative;
        }

        .mouth {
            position: absolute;
            bottom: 20%;
            width: 18vmin;
            height: 10vmin;
            border-radius: 50%;
            border-bottom: 1vmin solid #000;
            animation: mouth-move 5s infinite;
        }

        @keyframes mouth-move {
            0%, 20%, 100% {
                width: 18vmin;
                height: 10vmin;
            }
            10% {
                width: 20vmin;
                height: 12vmin;
            }
        }

        .ear {
            position: absolute;
            width: 15vmin;
            height: 20vmin;
            background-color: #fff;
            border-radius: 70% 70% 0 0;
            z-index: -1;
        }

        #left-ear {
            top: -5%;
            left: 15%;
            transform: rotate(-10deg);
        }

        #right-ear {
            top: -5%;
            right: 15%;
            transform: rotate(10deg);
        }

        .whiskers {
            position: absolute;
            width: 60%;
            display: flex;
            justify-content: space-between;
        }

        .whisker-group {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 15vmin;
        }

        .whisker {
            width: 12vmin;
            height: 0.5vmin;
            background-color: #000;
            margin: 1vmin 0;
        }

        .left-whiskers .whisker {
            transform-origin: left center;
            transform: rotate(5deg);
        }

        .right-whiskers .whisker {
            transform-origin: right center;
            transform: rotate(-5deg);
        }

        #whiskers-container {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 5%;
        }

        #control-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #control-panel.active {
            opacity: 1;
            pointer-events: all;
        }

        #follow-btn {
            padding: 5vmin;
            font-size: 5vmin;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 2vmin;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 5vmin;
        }

        #follow-btn:hover,
        #follow-btn:active {
            transform: scale(1.05);
            background-color: #45a049;
        }

        #restart-btn {
            padding: 5vmin;
            font-size: 5vmin;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 2vmin;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 5vmin;
        }

        #restart-btn:hover,
        #restart-btn:active {
            transform: scale(1.05);
            background-color: #0b7dda;
        }

        #back-btn {
            padding: 3vmin 5vmin;
            font-size: 3vmin;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 2vmin;
            cursor: pointer;
            margin-bottom: 5vmin;
        }

        #back-btn:hover,
        #back-btn:active {
            background-color: #d32f2f;
        }

        /* Styles for the stop button */
        #stop-btn {
            padding: 5vmin;
            font-size: 5vmin;
            background-color: #ff3333;
            color: white;
            border: none;
            border-radius: 2vmin;
            cursor: pointer;
            margin-top: 20px;
            width: 80%;
            font-weight: bold;
        }

        #stop-btn:hover,
        #stop-btn:active {
            background-color: #cc0000;
        }

        .expression {
            animation: expression-change 10s infinite;
        }

        @keyframes expression-change {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            75% { transform: scale(0.98); }
        }

        @keyframes blink {
            0%, 96%, 98% {
                transform: scaleY(1);
            }
            97% {
                transform: scaleY(0.1);
            }
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 5vmin;
        }

        /* Manual control styles */
        .manual-controls {
            background-color: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            width: 80%;
            max-width: 400px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-gap: 10px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .control-btn:hover {
            background-color: #2980b9;
        }

        #stop-manual-btn {
            background-color: #e74c3c;
        }

        #stop-manual-btn:hover {
            background-color: #c0392b;
        }

        .speed-control {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }

        .speed-control label {
            margin-right: 10px;
        }

        .speed-control input {
            margin-right: 10px;
            width: 60%;
        }

        #show-controls-btn {
            background-color: #2ecc71;
        }

        #show-controls-btn:hover {
            background-color: #27ae60;
        }

        .manual-controls h2 {
            color: white;
            margin-top: 0;
        }
    </style>
</head>
<body>
<div id="cat-container">
    <div id="cat-face" class="expression">
        <div id="left-ear" class="ear"></div>
        <div id="right-ear" class="ear"></div>

        <div class="eyes">
            <div class="eye">
                <div class="pupil"></div>
            </div>
            <div class="eye">
                <div class="pupil"></div>
            </div>
        </div>

        <div class="mouth"></div>

        <div id="whiskers-container">
            <div class="whisker-group left-whiskers">
                <div class="whisker"></div>
                <div class="whisker"></div>
                <div class="whisker"></div>
            </div>
            <div class="whisker-group right-whiskers">
                <div class="whisker"></div>
                <div class="whisker"></div>
                <div class="whisker"></div>
            </div>
        </div>
    </div>
</div>

<div id="control-panel">
    <div class="button-container">
        <button id="follow-btn">Follow Path</button>
        <button id="back-btn">Back to Cat</button>
        <button id="stop-btn">STOP</button>
    </div>

    <div class="manual-controls" id="manual-controls" style="display: none;">
        <h2>Manual Controls</h2>
        <div class="controls-grid">
            <div></div>
            <button id="forward-btn" class="control-btn">Forward</button>
            <div></div>
            <button id="left-btn" class="control-btn">Left</button>
            <button id="stop-manual-btn" class="control-btn">Stop</button>
            <button id="right-btn" class="control-btn">Right</button>
            <div></div>
            <button id="backward-btn" class="control-btn">Backward</button>
            <div></div>
        </div>
        <div class="speed-control">
            <label for="speed-slider">Speed: </label>
            <input type="range" id="speed-slider" min="50" max="300" value="150">
            <span id="speed-value">150</span>
        </div>
        <button id="hide-controls-btn" class="control-btn">Hide Controls</button>
    </div>
    <button id="show-controls-btn" class="control-btn" style="margin-top: 10px;">Manual Controls</button>
</div>

<script>
    // Add blinking animation to pupils
    const pupils = document.querySelectorAll('.pupil');
    pupils.forEach(pupil => {
        pupil.style.animation = "blink 4s infinite";
    });

    // Show control panel when touching the cat face
    document.getElementById('cat-container').addEventListener('click', function() {
        document.getElementById('control-panel').classList.add('active');
    });

    // Hide control panel when clicking "Back to Cat" button
    document.getElementById('back-btn').addEventListener('click', function(event) {
        event.stopPropagation(); // Prevent triggering the cat-container click event
        document.getElementById('control-panel').classList.remove('active');
    });

    // Handle the line following button
    document.getElementById('follow-btn').addEventListener('click', function(event) {
        event.stopPropagation(); // Prevent triggering the cat-container click event

        fetch('/seekColor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'color=lime'
        })
            .then(response => response.text())
            .then(data => {
                console.log('Line following response:', data);
            })
            .catch(error => {
                console.error('Error starting line following:', error);
            });
    });

    // Handle the stop button
    document.getElementById('stop-btn').addEventListener('click', function(event) {
        event.stopPropagation(); // Prevent triggering the cat-container click event

        fetch('/stop', {
            method: 'POST'
        })
            .then(response => response.text())
            .then(data => {
                console.log('Stop response:', data);
            })
            .catch(error => {
                console.error('Error stopping:', error);
            });
    });

    // Manual control functionality
    document.addEventListener('DOMContentLoaded', function() {
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const showControlsBtn = document.getElementById('show-controls-btn');
        const hideControlsBtn = document.getElementById('hide-controls-btn');
        const manualControls = document.getElementById('manual-controls');

        // Show/hide controls
        showControlsBtn.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent triggering the cat-container click event
            manualControls.style.display = 'block';
            showControlsBtn.style.display = 'none';
        });

        hideControlsBtn.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent triggering the cat-container click event
            manualControls.style.display = 'none';
            showControlsBtn.style.display = 'block';
        });

        // Update speed value display
        speedSlider.addEventListener('input', function() {
            speedValue.textContent = speedSlider.value;
        });

        // Movement controls
        const controlButtons = {
            'forward-btn': { action: 'forward' },
            'backward-btn': { action: 'backward' },
            'left-btn': { action: 'left' },
            'right-btn': { action: 'right' },
            'stop-manual-btn': { action: 'stop' }
        };

        // Set up button event listeners
        Object.keys(controlButtons).forEach(btnId => {
            const button = document.getElementById(btnId);
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent triggering the cat-container click event
                const speed = parseInt(speedSlider.value);
                sendMovementCommand(controlButtons[btnId].action, speed);
            });
        });

        // Send movement command to server - fixed implementation
        function sendMovementCommand(action, speed) {
            const formData = new URLSearchParams();
            formData.append('command', action);
            formData.append('speed', speed);

            fetch('/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            })
                .then(response => response.text())
                .then(data => {
                    console.log('Movement response:', data);
                })
                .catch(error => {
                    console.error('Error sending movement command:', error);
                });
        }
    });
</script>
</body>
</html>